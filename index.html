<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø± | Live Streaming</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .navbar {
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 15px 20px;
            margin-bottom: 20px;
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
            max-width: 1400px;
            margin-left: auto;
            margin-right: auto;
        }

        .navbar h1 {
            font-size: 1.5em;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 15px;
            background: rgba(255,255,255,0.2);
            border-radius: 8px;
        }

        .live-dot {
            width: 12px;
            height: 12px;
            background: #e74c3c;
            border-radius: 50%;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
        }

        .main-section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }

        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .video-container {
            position: relative;
            width: 100%;
            background: #000;
            border-radius: 10px;
            overflow: hidden;
            aspect-ratio: 16 / 9;
            margin-bottom: 20px;
        }

        video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .video-placeholder {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            color: white;
            font-size: 1.5em;
        }

        .controls-section {
            background: rgba(102, 126, 234, 0.1);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 15px;
        }

        .control-group label {
            font-weight: bold;
            color: #667eea;
        }

        .control-group input {
            padding: 10px;
            border: 2px solid #667eea;
            border-radius: 8px;
            font-size: 1em;
        }

        .button-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .btn {
            padding: 12px;
            font-size: 1em;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            color: white;
        }

        .btn-primary {
            background: #667eea;
            grid-column: 1 / -1;
        }

        .btn-primary:hover {
            background: #764ba2;
            transform: translateY(-2px);
        }

        .btn-danger {
            background: #e74c3c;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .btn-toggle {
            background: #f39c12;
        }

        .btn-toggle:hover {
            background: #e67e22;
        }

        .info-card {
            background: white;
            border-radius: 10px;
            padding: 15px;
            border-left: 4px solid #667eea;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .info-card h3 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .info-value {
            font-size: 1.3em;
            font-weight: bold;
            color: #333;
        }

        .chat-section {
            background: white;
            border-radius: 10px;
            padding: 15px;
            display: flex;
            flex-direction: column;
            max-height: 400px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .chat-section h3 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            background: #f9f9f9;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
        }

        .message {
            padding: 10px;
            margin: 8px 0;
            border-radius: 8px;
            background: white;
            border-left: 4px solid #667eea;
            font-size: 0.95em;
            animation: slideIn 0.3s ease-out;
        }

        .message.system {
            background: linear-gradient(135deg, #f39c12 0%, #f1c40f 100%);
            border-left-color: #e67e22;
            font-style: italic;
            color: #333;
            font-weight: 500;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .message-sender {
            font-weight: bold;
            color: #667eea;
            font-size: 0.9em;
        }

        .message-text {
            margin-top: 5px;
            word-wrap: break-word;
            line-height: 1.4;
        }

        .chat-input-group {
            display: flex;
            gap: 8px;
        }

        .chat-input-group input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 0.9em;
        }

        .chat-input-group button {
            padding: 10px 15px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
        }

        .chat-input-group button:hover {
            background: #764ba2;
        }

        .status-badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: bold;
        }

        .status-badge.online {
            background: #27ae60;
            color: white;
        }

        .status-badge.offline {
            background: #95a5a6;
            color: white;
        }

        .tab-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #ddd;
            padding-bottom: 15px;
        }

        .tab-btn {
            padding: 10px 20px;
            background: transparent;
            border: none;
            cursor: pointer;
            font-weight: bold;
            color: #999;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .tab-btn.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .home-section {
            text-align: center;
        }

        .home-section h1 {
            color: #667eea;
            font-size: 2.5em;
            margin-bottom: 20px;
        }

        .features {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .feature {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .feature-icon {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .feature h3 {
            color: #667eea;
        }

        @media (max-width: 1024px) {
            .container {
                grid-template-columns: 1fr;
            }

            .button-group {
                grid-template-columns: 1fr;
            }

            .btn-primary {
                grid-column: 1;
            }

            .tab-buttons {
                justify-content: space-around;
            }
        }
    </style>
</head>
<body>
    <div class="navbar">
        <h1>ğŸ“¡ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø±</h1>
        <div class="status-indicator" id="broadcastStatus">
            <span>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨Ø« Ù†Ø´Ø·</span>
        </div>
    </div>

    <div class="container">
        <div class="main-section">
            <div class="tab-buttons">
                <button class="tab-btn active" onclick="switchTab('home')">ğŸ  Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
                <button class="tab-btn" onclick="switchTab('broadcast')">ğŸ¬ Ø§Ù„Ø¨Ø«</button>
                <button class="tab-btn" onclick="switchTab('watch')">ğŸ‘ï¸ Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø©</button>
            </div>

            <!-- Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© -->
            <div id="home" class="tab-content active home-section">
                <h1>Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø±</h1>
                <p style="font-size: 1.2em; color: #666; margin-bottom: 30px;">Ù…Ù†ØµØ© Ø¨Ø« Ù…Ø¨Ø§Ø´Ø± Ø§Ø­ØªØ±Ø§ÙÙŠØ© ÙˆØ³Ù‡Ù„Ø© Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…</p>
                
                <div class="features">
                    <div class="feature">
                        <div class="feature-icon">ğŸ¥</div>
                        <h3>Ø¨Ø« Ù…Ø¨Ø§Ø´Ø±</h3>
                        <p>Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¨Ø« Ù…Ù† Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ù…Ø¨Ø§Ø´Ø±Ø©</p>
                    </div>
                    <div class="feature">
                        <div class="feature-icon">ğŸ‘¥</div>
                        <h3>Ù…Ø´Ø§Ù‡Ø¯ÙŠÙ† ØºÙŠØ± Ù…Ø­Ø¯ÙˆØ¯</h3>
                        <p>Ø¹Ø¯Ø¯ ØºÙŠØ± Ù…Ø­Ø¯ÙˆØ¯ Ù…Ù† Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯ÙŠÙ†</p>
                    </div>
                    <div class="feature">
                        <div class="feature-icon">ğŸ’¬</div>
                        <h3>Ø¯Ø±Ø¯Ø´Ø© ÙÙˆØ±ÙŠØ©</h3>
                        <p>ØªÙØ§Ø¹Ù„ Ù…Ø¹ Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯ÙŠÙ†</p>
                    </div>
                    <div class="feature">
                        <div class="feature-icon">ğŸ“Š</div>
                        <h3>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª ÙÙˆØ±ÙŠØ©</h3>
                        <p>Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¨Ø« Ø§Ù„Ø­ÙŠØ©</p>
                    </div>
                </div>

                <p style="color: #666; margin-top: 30px;">Ø§Ø®ØªØ± Ù…Ù† Ø§Ù„Ø£Ø¹Ù„Ù‰: Ø§Ù„Ø¨Ø« Ø£Ùˆ Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø©</p>
            </div>

            <!-- Ø§Ù„Ø¨Ø« -->
            <div id="broadcast" class="tab-content">
                <h2 style="color: #667eea; margin-bottom: 20px;">ğŸ¬ Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø±</h2>
                
                <div class="video-container" id="videoContainer">
                    <div class="video-placeholder">
                        <div>ğŸ¬ ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø¨Ø«...</div>
                    </div>
                </div>

                <div class="control-group">
                    <label>Ø§Ø³Ù…Ùƒ:</label>
                    <input type="text" id="broadcasterName" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ" value="Ø§Ù„Ù…ÙØ¨Ø«">
                </div>

                <div class="button-group">
                    <button class="btn btn-primary" onclick="startBroadcast()">â–¶ï¸ Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¨Ø«</button>
                    <button class="btn btn-toggle" id="toggleVideoBtn" onclick="toggleVideo()" style="display: none;">ğŸ“¹ Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ÙÙŠØ¯ÙŠÙˆ</button>
                    <button class="btn btn-toggle" id="toggleAudioBtn" onclick="toggleAudio()" style="display: none;">ğŸ¤ Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØµÙˆØª</button>
                    <button class="btn btn-danger" id="stopBtn" onclick="stopBroadcast()" style="display: none;">â¹ï¸ Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¨Ø«</button>
                </div>

                <div style="background: #f0f4ff; padding: 15px; border-radius: 8px; margin-top: 15px; border-left: 4px solid #667eea;">
                    <p style="color: #333; font-size: 0.9em;"><strong>ğŸ’¡ Ù…Ù„Ø§Ø­Ø¸Ø©:</strong> Ø´Ø§Ø±Ùƒ Ø±Ø§Ø¨Ø· Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù…Ø¹ Ù…Ù† ØªØ±ÙŠØ¯ Ø£Ù† ÙŠØ´Ø§Ù‡Ø¯Ùƒ</p>
                </div>
            </div>

            <!-- Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø© -->
            <div id="watch" class="tab-content">
                <h2 style="color: #667eea; margin-bottom: 20px;">ğŸ‘ï¸ Ø§Ø´ØªØ±Ùƒ ÙÙŠ Ø§Ù„Ø¨Ø«</h2>
                
                <div class="video-container" id="viewerVideoContainer">
                    <div class="video-placeholder">
                        <div>ğŸ¬ ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø¨Ø«...</div>
                    </div>
                </div>

                <div class="control-group">
                    <label>Ø§Ø³Ù…Ùƒ:</label>
                    <input type="text" id="viewerName" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ" value="Ù…Ø´Ø§Ù‡Ø¯">
                </div>

                <button class="btn btn-primary" onclick="joinBroadcast()">ğŸ”— Ø§Ù†Ø¶Ù… Ù„Ù„Ø¨Ø«</button>
                <button class="btn btn-danger" id="leaveBtn" onclick="leaveBroadcast()" style="display: none; margin-top: 10px; grid-column: 1 / -1;">âŒ ØºØ§Ø¯Ø± Ø§Ù„Ø¨Ø«</button>
            </div>
        </div>

        <div class="sidebar">
            <div class="info-card">
                <h3>ğŸ“Š Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¨Ø«</h3>
                <div style="margin-bottom: 10px;">
                    <small>Ø§Ù„Ø­Ø§Ù„Ø©:</small>
                    <div class="info-value"><span class="status-badge offline" id="statusBadge">Ù…Ø¹Ø·Ù‘Ù„</span></div>
                </div>
                <div>
                    <small>Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯ÙŠÙ†:</small>
                    <div class="info-value" id="viewersCount">0</div>
                </div>
            </div>

            <div class="chat-section">
                <h3>ğŸ’¬ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©</h3>
                <div class="chat-messages" id="chatMessages"></div>
                <div class="chat-input-group">
                    <input type="text" id="chatInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©..." onkeypress="if(event.key==='Enter') sendMessage()">
                    <button onclick="sendMessage()">Ø£Ø±Ø³Ù„</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============ Ù…ØªØºÙŠØ±Ø§Øª Ø¹Ø§Ù…Ø© ============
        let localStream;
        let isBroadcasting = false;
        let isViewing = false;
        let broadcasterId = null;
        let viewers = [];
        let chatHistory = [];

        // ============ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ============
        window.addEventListener('DOMContentLoaded', () => {
            loadChatHistory();
        });

        // ============ Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª ============
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
        }

        // ============ Ø§Ù„Ø¨Ø« ============
        async function startBroadcast() {
            try {
                localStream = await navigator.mediaDevices.getUserMedia({
                    video: { width: 1280, height: 720 },
                    audio: true
                });

                const videoContainer = document.getElementById('videoContainer');
                videoContainer.innerHTML = '';
                const video = document.createElement('video');
                video.autoplay = true;
                video.muted = true;
                video.playsinline = true;
                video.style.transform = 'scaleX(-1)';
                video.srcObject = localStream;
                videoContainer.appendChild(video);

                document.getElementById('toggleVideoBtn').style.display = 'inline-block';
                document.getElementById('toggleAudioBtn').style.display = 'inline-block';
                document.getElementById('stopBtn').style.display = 'inline-block';
                document.querySelector('#broadcast .btn-primary').style.display = 'none';

                isBroadcasting = true;
                broadcasterId = 'broadcaster_' + Date.now();

                updateBroadcastStatus(true, document.getElementById('broadcasterName').value);
                addChatMessage('Ø§Ù„Ù†Ø¸Ø§Ù…', 'ğŸ¬ Ø¨Ø¯Ø£ Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø± Ø§Ù„Ø¢Ù†!', true);

            } catch (error) {
                console.error('Ø®Ø·Ø£:', error);
                alert('Ø®Ø·Ø£: ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø³Ù…Ø§Ø­ Ù„Ù„Ù…ÙˆÙ‚Ø¹ Ø¨Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„ÙƒØ§Ù…ÙŠØ±Ø§');
            }
        }

        function stopBroadcast() {
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
            }

            isBroadcasting = false;
            document.getElementById('videoContainer').innerHTML = '<div class="video-placeholder"><div>ğŸ¬ ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø¨Ø«...</div></div>';
            document.getElementById('toggleVideoBtn').style.display = 'none';
            document.getElementById('toggleAudioBtn').style.display = 'none';
            document.getElementById('stopBtn').style.display = 'none';
            document.querySelector('#broadcast .btn-primary').style.display = 'block';

            updateBroadcastStatus(false);
            addChatMessage('Ø§Ù„Ù†Ø¸Ø§Ù…', 'â¹ï¸ ØªÙˆÙ‚Ù Ø§Ù„Ø¨Ø«', true);
        }

        function toggleVideo() {
            const tracks = localStream.getVideoTracks();
            if (tracks.length > 0) {
                tracks[0].enabled = !tracks[0].enabled;
                document.getElementById('toggleVideoBtn').textContent = tracks[0].enabled ? 'ğŸ“¹ Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ÙÙŠØ¯ÙŠÙˆ' : 'ğŸ“¹ ØªØ´ØºÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ';
            }
        }

        function toggleAudio() {
            const tracks = localStream.getAudioTracks();
            if (tracks.length > 0) {
                tracks[0].enabled = !tracks[0].enabled;
                document.getElementById('toggleAudioBtn').textContent = tracks[0].enabled ? 'ğŸ¤ Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØµÙˆØª' : 'ğŸ¤ ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª';
            }
        }

        // ============ Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø© ============
        function joinBroadcast() {
            isViewing = true;
            const viewerName = document.getElementById('viewerName').value || 'Ù…Ø´Ø§Ù‡Ø¯';
            viewers.push(viewerName);
            
            document.querySelector('#watch .btn-primary').style.display = 'none';
            document.getElementById('leaveBtn').style.display = 'block';

            updateViewersCount();
            addChatMessage('Ø§Ù„Ù†Ø¸Ø§Ù…', `âœ… ${viewerName} Ø§Ù†Ø¶Ù… Ù„Ù„Ø¨Ø«`, true);

            simulateBroadcast();
        }

        function leaveBroadcast() {
            isViewing = false;
            const viewerName = document.getElementById('viewerName').value;
            viewers = viewers.filter(v => v !== viewerName);

            document.querySelector('#watch .btn-primary').style.display = 'block';
            document.getElementById('leaveBtn').style.display = 'none';
            document.getElementById('viewerVideoContainer').innerHTML = '<div class="video-placeholder"><div>ğŸ¬ ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø¨Ø«...</div></div>';

            updateViewersCount();
            addChatMessage('Ø§Ù„Ù†Ø¸Ø§Ù…', `ğŸ‘‹ ${viewerName} ØºØ§Ø¯Ø± Ø§Ù„Ø¨Ø«`, true);
        }

        function simulateBroadcast() {
            if (!isBroadcasting) {
                document.getElementById('viewerVideoContainer').innerHTML = '<div class="video-placeholder"><div style="padding: 20px; text-align: center;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨Ø« Ù†Ø´Ø· Ø§Ù„Ø¢Ù†<br>ğŸ”´ ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø¨Ø« Ø¬Ø¯ÙŠØ¯</div></div>';
                return;
            }

            const canvas = document.createElement('canvas');
            canvas.width = 1280;
            canvas.height = 720;
            const ctx = canvas.getContext('2d');

            ctx.fillStyle = '#667eea';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = 'white';
            ctx.font = 'bold 48px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText('ğŸ¥ Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø±', canvas.width / 2, canvas.height / 2 - 50);
            ctx.font = '24px Arial';
            ctx.fillText(`Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯ÙŠÙ†: ${viewers.length}`, canvas.width / 2, canvas.height / 2 + 50);

            const stream = canvas.captureStream(30);
            const videoElement = document.getElementById('viewerVideoContainer').querySelector('video') || document.createElement('video');
            if (!document.getElementById('viewerVideoContainer').querySelector('video')) {
                videoElement.autoplay = true;
                videoElement.playsinline = true;
                document.getElementById('viewerVideoContainer').innerHTML = '';
                document.getElementById('viewerVideoContainer').appendChild(videoElement);
            }
            videoElement.srcObject = stream;
        }

        // ============ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© ============
        function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();

            if (message) {
                const sender = isBroadcasting ? 
                    (document.getElementById('broadcasterName').value || 'Ø§Ù„Ù…ÙØ¨Ø«') :
                    (document.getElementById('viewerName').value || 'Ù…Ø´Ø§Ù‡Ø¯');
                
                const messageObj = {
                    sender: sender,
                    text: message,
                    time: new Date().toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' }),
                    isSystem: false,
                    isBroadcaster: isBroadcasting
                };

                addChatMessage(messageObj.sender, messageObj.text, false, false, messageObj.time, messageObj.isBroadcaster);
                chatHistory.push(messageObj);
                saveChatHistory();
                input.value = '';
                input.focus();
            }
        }

        function addChatMessage(sender, text, isSystem = false, isOwn = false, time = '', isBroadcaster = false) {
            const chatMessages = document.getElementById('chatMessages');
            const messageEl = document.createElement('div');
            messageEl.className = isSystem ? 'message system' : 'message';

            if (!time) {
                time = new Date().toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' });
            }

            if (isSystem) {
                messageEl.innerHTML = `
                    <div style="display: flex; justify-content: space-between;">
                        <span>${text}</span>
                        <span style="font-size: 0.75em; opacity: 0.7;">${time}</span>
                    </div>
                `;
            } else {
                const badge = isBroadcaster ? ' ğŸ”´ Ù…ÙØ¨Ø«' : '';
                const icon = isBroadcaster ? 'ğŸ™ï¸' : 'ğŸ‘¤';
                messageEl.innerHTML = `
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span class="message-sender">${icon} ${sender}${badge}</span>
                        <span style="font-size: 0.75em; opacity: 0.7;">${time}</span>
                    </div>
                    <div class="message-text">${escapeHtml(text)}</div>
                `;
            }

            chatMessages.appendChild(messageEl);
            chatMessages.scrollTop = chatMessages.scrollHeight;

            if (chatMessages.children.length > 150) {
                chatMessages.removeChild(chatMessages.firstChild);
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ============ Ø­ÙØ¸ ÙˆØ§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© ============
        function saveChatHistory() {
            localStorage.setItem('chatHistory', JSON.stringify(chatHistory));
        }

        function loadChatHistory() {
            const saved = localStorage.getItem('chatHistory');
            if (saved) {
                chatHistory = JSON.parse(saved);
                chatHistory.forEach(msg => {
                    if (!msg.isSystem) {
                        addChatMessage(msg.sender, msg.text, false, false, msg.time, msg.isBroadcaster);
                    }
                });
            }
        }

        // ============ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¨Ø« ============
        function updateBroadcastStatus(isActive, broadcasterName = '') {
            const statusIndicator = document.getElementById('broadcastStatus');
            const statusBadge = document.getElementById('statusBadge');

            if (isActive) {
                statusIndicator.innerHTML = `
                    <div class="live-dot"></div>
                    <span>ğŸ”´ Ø¨Ø« Ù…Ø¨Ø§Ø´Ø±: ${broadcasterName}</span>
                `;
                statusBadge.className = 'status-badge online';
                statusBadge.textContent = 'Ù…Ø¨Ø§Ø´Ø± ğŸ”´';
            } else {
                statusIndicator.innerHTML = '<span>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨Ø« Ù†Ø´Ø·</span>';
                statusBadge.className = 'status-badge offline';
                statusBadge.textContent = 'Ù…Ø¹Ø·Ù‘Ù„';
            }
        }

        function updateViewersCount() {
            document.getElementById('viewersCount').textContent = viewers.length;
        }

        // Ø§Ù„ØªÙ†Ø¸ÙŠÙ Ø¹Ù†Ø¯ Ø§Ù„Ø®Ø±ÙˆØ¬
        window.addEventListener('beforeunload', () => {
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
            }
        });
    </script>
</body>
</html>